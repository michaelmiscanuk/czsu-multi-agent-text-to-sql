flowchart TB
    %% Start Node
    Start([üöÄ Function Entry<br/>main.py]):::startNode
    
    %% ============================================================
    %% PHASE 1: INITIALIZATION
    %% ============================================================
    subgraph Phase1["<b>PHASE 1: INITIALIZATION</b>"]
        direction TB
        Step1[üìù Resolve Input Parameters<br/><i>prompt, thread_id, run_id</i>]:::initNode
        Step2[üíæ Establish Memory Baseline<br/><i>track RSS memory usage</i>]:::initNode
        Step3[üóÑÔ∏è Initialize Checkpointer<br/><i>PostgreSQL or InMemory fallback</i>]:::initNode
        Step4[üîß Create LangGraph Workflow<br/><i>17 nodes across 6 stages</i>]:::initNode
        
        Step1 --> Step2
        Step2 --> Step3
        Step3 --> Step4
    end
    
    %% ============================================================
    %% PHASE 2: STATE PREPARATION
    %% ============================================================
    subgraph Phase2["<b>PHASE 2: STATE PREPARATION</b>"]
        direction TB
        Step5[üîç Check Existing State<br/><i>query checkpointer for messages</i>]:::stateNode
        Decision1{Existing<br/>Conversation?}:::decisionNode
        Step6A[üÜï New Conversation<br/><i>Initialize complete state<br/>13 fields + follow-up prompts</i>]:::stateNode
        Step6B[üîÑ Continuing Conversation<br/><i>Reset iteration fields<br/>preserve message history</i>]:::stateNode
        
        Step5 --> Decision1
        Decision1 -->|NO| Step6A
        Decision1 -->|YES| Step6B
    end
    
    %% ============================================================
    %% PHASE 3: LANGGRAPH EXECUTION (THE MAIN EVENT)
    %% ============================================================
    GraphExec["<b>‚ö° EXECUTE LANGGRAPH WORKFLOW</b><br/>graph.ainvoke<br/><br/>‚Ä¢ Query Rewriting<br/>‚Ä¢ Parallel Retrieval DB + PDF<br/>‚Ä¢ SQL Generation MCP tools<br/>‚Ä¢ Self-Correction Loop<br/>‚Ä¢ Answer Synthesis"]:::execNode
    
    %% ============================================================
    %% PHASE 4: POST-EXECUTION MONITORING
    %% ============================================================
    subgraph Phase4["<b>PHASE 4: POST-EXECUTION MONITORING</b>"]
        direction TB
        Step7[üìä Monitor Memory Growth<br/><i>compare before/after RSS</i>]:::monitorNode
        Decision2{Memory Growth<br/>> Threshold?}:::decisionNode
        Step8[üö® Emergency Cleanup<br/><i>force garbage collection</i>]:::emergencyNode
        
        Step7 --> Decision2
        Decision2 -->|YES| Step8
        Decision2 -->|NO| Merge2[ ]:::mergeNode
        Step8 --> Merge2
    end
    
    %% ============================================================
    %% PHASE 5: RESULT PROCESSING
    %% ============================================================
    subgraph Phase5["<b>PHASE 5: RESULT PROCESSING</b>"]
        direction TB
        Step9[üì¶ Extract Key Results<br/><i>answer, SQL queries, datasets</i>]:::resultNode
        Step10[üîé Filter Used Dataset Codes<br/><i>parse SQL for table names</i>]:::resultNode
        Step11[üìÑ Serialize PDF Chunks<br/><i>Document to JSON format</i>]:::resultNode
        
        Step9 --> Step10
        Step10 --> Step11
    end
    
    %% ============================================================
    %% PHASE 6: FINAL CLEANUP
    %% ============================================================
    subgraph Phase6["<b>PHASE 6: FINAL CLEANUP</b>"]
        direction TB
        Step12[üßπ Final Garbage Collection<br/><i>release temporary resources</i>]:::cleanupNode
        Step13[üìù Log Memory Statistics<br/><i>total growth & diagnostics</i>]:::cleanupNode
        
        Step12 --> Step13
    end
    
    %% End Node
    End([‚úÖ Return Serialized Result<br/>API Response]):::endNode
    
    %% ============================================================
    %% MAIN FLOW CONNECTIONS
    %% ============================================================
    Start --> Phase1
    Phase1 --> Phase2
    Step6A --> Merge1[ ]:::mergeNode
    Step6B --> Merge1
    Merge1 --> GraphExec
    GraphExec --> Phase4
    Phase4 --> Phase5
    Phase5 --> Phase6
    Phase6 --> End
    
    %% ============================================================
    %% STYLING
    %% ============================================================
    classDef startNode fill:#d5e8d4,stroke:#82b366,stroke-width:3px,color:#000
    classDef endNode fill:#d5e8d4,stroke:#82b366,stroke-width:3px,color:#000
    classDef initNode fill:#dae8fc,stroke:#6c8ebf,stroke-width:2px,color:#000
    classDef stateNode fill:#fff2cc,stroke:#d6b656,stroke-width:2px,color:#000
    classDef execNode fill:#f8cecc,stroke:#b85450,stroke-width:4px,color:#000,font-weight:bold
    classDef monitorNode fill:#e1d5e7,stroke:#9673a6,stroke-width:2px,color:#000
    classDef emergencyNode fill:#f8cecc,stroke:#b85450,stroke-width:2px,color:#000
    classDef resultNode fill:#d5e8d4,stroke:#82b366,stroke-width:2px,color:#000
    classDef cleanupNode fill:#e1d5e7,stroke:#9673a6,stroke-width:2px,color:#000
    classDef decisionNode fill:#ffe6cc,stroke:#d79b00,stroke-width:2px,color:#000
    classDef mergeNode fill:#000,stroke:#000,stroke-width:1px,color:#000
    
    %% ============================================================
    %% NOTES & STATISTICS
    %% ============================================================
    Note1["<b>üìä KEY STATISTICS</b><br/><br/><b>Before Execution:</b><br/>‚úì 4 initialization steps<br/>‚úì Checkpointer setup<br/>‚úì State detection & prep<br/><br/><b>During Execution:</b><br/>‚úì 17 workflow nodes<br/>‚úì Parallel retrieval<br/>‚úì Iterative SQL generation<br/><br/><b>After Execution:</b><br/>‚úì Memory monitoring<br/>‚úì Result extraction<br/>‚úì Final cleanup"]:::noteBox
    
    Note2["<b>‚è±Ô∏è PERFORMANCE</b><br/><br/>‚Ä¢ Execution: 5-15 sec<br/>‚Ä¢ Memory Growth: 50-150 MB<br/>‚Ä¢ Phases: 6 stages<br/>‚Ä¢ Decision Points: 2"]:::noteBox
    
    classDef noteBox fill:#f5f5f5,stroke:#666,stroke-width:2px,stroke-dasharray: 5 5,color:#000,text-align:left
    
    GraphExec -.->|stats| Note1
    End -.->|metrics| Note2
